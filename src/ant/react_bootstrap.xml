<?xml version="1.0" encoding="UTF-8"?>
<project name="React Bootstrap">

    <target name="-react:yarn-manually-disabled">
        <condition property="yarn-manually-disabled" else="false">
            <equals arg1="${env.DISABLE_YARN_INSTALL}" arg2="1" />
        </condition>
    </target>

    <target name="-react:should-yarn-install" depends="-react:yarn-manually-disabled">
        <echo message="DISABLE_YARN_INSTALL: '${env.DISABLE_YARN_INSTALL}'" />
        <condition property="perform-yarn-install" else="false">
            <and>
                <isfalse value="${production}" />
                <not>
                    <istrue value="${yarn-manually-disabled}" />
                </not>
            </and>
        </condition>
    </target>

    <target name="react:bootstrap" if="${perform-yarn-install}" extensionOf="-prepare:before~hook" depends="-react:should-yarn-install">
        <tool-exists executable="yarn" />

        <echo>Executing global yarn install for all workspaces</echo>
        <echo>That might take some time, but its the only yarn install we need now</echo>
        <echo>Please hang on and maybe get cold beverage ...</echo>

        <!-- Perform global js-install -->
        <!-- This is actually a global task but since Catwalk is used everywhere, we are doing it here -->
        <exec executable="yarn" failonerror="true" dir="${frontastic_basedir}">
            <env key="CI" value="true" />

            <arg value="--network-timeout" />
            <arg value="1000000000" />

            <!-- This is a workaround for ENOENT errors: https://github.com/yarnpkg/yarn/issues/2629 -->
            <arg value="--mutex" />
            <arg value="network" />
            <arg value="--network-concurrency" />
            <arg value="1" />

            <arg value="install" />
        </exec>
    </target>

    <target name="-react:message-no-yarn-install" if="${yarn-manually-disabled}" extensionOf="-prepare:before~hook" depends="-react:yarn-manually-disabled">
        <echo>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! yarn install DISABLED !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</echo>
        <echo>! You will need to install JS dependencies by yourself using `yarn install` in checkout root !</echo>
        <echo>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</echo>
    </target>
</project>
